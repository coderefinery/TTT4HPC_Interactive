<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data sync &mdash; Real-life compute cluster workflows  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_lesson.css" />
      <link rel="stylesheet" type="text/css" href="../_static/term_role_formatting.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />

  
    <link rel="shortcut icon" href="../_static/coderefinery.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Code sync" href="../Code_sync/" />
    <link rel="prev" title="Project arrangement" href="../Project_arrangement/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            Real-life compute cluster workflows
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Welcome/">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Motivation/">Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Project_arrangement/">Project arrangement</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data sync</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#making-a-data-plan">Making a data plan</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-data-plan-for-a-distributed-project">Example data plan for a distributed project</a></li>
<li class="toctree-l2"><a class="reference internal" href="#transferring-data">Transferring data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rsync-smart-file-transfer">rsync: smart file transfer</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#syncing-data-two-ways">Syncing data two-ways</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#unison-syncing-data">Unison: syncing data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-unison">Using unison</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#git-annex">git-annex</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mounting-data-from-place-to-place">Mounting data from place to place</a></li>
<li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Code_sync/">Code sync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Working_interactively/">Working interactively</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VSCode/">VSCode</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../instructor-guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">Real-life compute cluster workflows</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Data sync</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/coderefinery/content/blob/main/content/Data_sync.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="data-sync">
<h1>Data sync<a class="headerlink" href="#data-sync" title="Permalink to this heading"></a></h1>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Make a data plan before you start: plan for the syncing you may need</p></li>
<li><p>You may need syncing for computing in multiple places, or for
setup/backup.</p></li>
<li><p>You can transfer data and make two copies.</p></li>
<li><p>You can mount data and use it from place to place</p></li>
</ul>
</div>
<section id="making-a-data-plan">
<h2>Making a data plan<a class="headerlink" href="#making-a-data-plan" title="Permalink to this heading"></a></h2>
<p>Make a plan before you start!  Or at least, understand how you may
need to adapt later.  You will almost always need some of:</p>
<ol class="arabic simple">
<li><p>Getting original data, making a copy for analysis</p></li>
<li><p>Archiving data after you are done</p></li>
<li><p>Moving data from place to place, <em>during</em> the project,</p></li>
<li><p>same as (3) but and <em>it may even be updated on both sides at the
same time.</em></p></li>
</ol>
<p>The first three are common and relatively easy, the last requires a
lot of care!</p>
<p>Consider:</p>
<ul class="simple">
<li><p><strong>There are different kinds of data</strong>.  Some can be re-constructed,
some must be made from scratch each time.</p></li>
<li><p><strong>Storage spaces have different properties</strong>: Some are good for
being same for archival.  Some are fast for analysis.  Not many are
good at both at the same time.</p></li>
<li><p>Will data be updated in multiple places, or in only one place at a
time?</p></li>
</ul>
</section>
<section id="example-data-plan-for-a-distributed-project">
<h2>Example data plan for a distributed project<a class="headerlink" href="#example-data-plan-for-a-distributed-project" title="Permalink to this heading"></a></h2>
<div class="admonition-demo demo admonition" id="demo-0">
<p class="admonition-title">Demo</p>
<p>Our project uses a lot of computational resources, so we might run
simulations on multiple clusters.  Data may be created on any, so we
need to carefully manage our data.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">project</span></code>: the main code of the project.  It is always synced with
git.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">project-data/</span></code>: The data for our project.  The code accesses this
data by using <code class="docutils literal notranslate"><span class="pre">../project-data/...</span></code>.  This is synced manually.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">input/</span></code>: Our input data.  Data is <em>only</em> added on our
workstation, syncing is always from the workstation to other
computer clusters.  Input data should never be modified, but if it
has to be, it’s modified on the workstation and then re-synced.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">computed/NNN/</span></code>: This is the computed data on any cluster.  Each
<code class="docutils literal notranslate"><span class="pre">NNN</span></code> is only computed on one cluster, and that is the only
cluster should modify the <code class="docutils literal notranslate"><span class="pre">computed/NNN</span></code> files.  This data is only
synced from cluster → workstation (and only the workstation has
the complete view on everything).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">analyzed/</span></code>: contains the final analysis that combines all of the
data.  This isn’t very hard, so is always run on my local
workstation so I can develop quickly.</p></li>
</ul>
</li>
</ul>
</div>
</section>
<section id="transferring-data">
<h2>Transferring data<a class="headerlink" href="#transferring-data" title="Permalink to this heading"></a></h2>
<p>Transfering data is relatively easy.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ssh</span></code> (and programs that use ssh) is the standard method</p></li>
<li><p>When data is super-massive, there are other protocols, but you’ll
learn them if you need them.</p></li>
<li><p>If you get two copies, you have to be careful <em>they don’t get out of
sync and you have to merge them together again</em>.</p></li>
</ul>
<section id="rsync-smart-file-transfer">
<h3>rsync: smart file transfer<a class="headerlink" href="#rsync-smart-file-transfer" title="Permalink to this heading"></a></h3>
<p>Rsync transfers files, but does so smartly:</p>
<ul class="simple">
<li><p>If only some parts of the file are changed, only transfer those
parts</p></li>
<li><p>Resume interrupted transfers</p></li>
<li><p>Mirror entire directory trees, including options for permissions,
timestamps, deleting files, etc.</p></li>
</ul>
<p>Basic usage:</p>
<p>There are many options for almost any problem you may have:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-t</span></code>: Preserve timestamps</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-a</span></code>: Mirror everything fully (includes <code class="docutils literal notranslate"><span class="pre">-r</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-r</span></code>: Recursive</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--update</span></code> skip files that are newer on the receiving end</p></li>
</ul>
<p>It can go either way, but it <em>can’t</em> go between two remotes.</p>
<div class="admonition-demonstration-of-unison demo admonition" id="demo-1">
<p class="admonition-title">Demonstration of unison</p>
<p>Syncing a directory from one place to another.  Show Unison from
command line without profiles</p>
</div>
<div class="highlight-{exercise}: notranslate"><div class="highlight"><pre><span></span>
- Rsync a directory from one computer to another, using `-a`
- Modify one file and re-run rsync (now with the `-v`) option, and
  verify that only the modified file is transferred
</pre></div>
</div>
</section>
</section>
<section id="syncing-data-two-ways">
<h2>Syncing data two-ways<a class="headerlink" href="#syncing-data-two-ways" title="Permalink to this heading"></a></h2>
<p>By it’s nature, <em>it has to keep records of the last state on each
side, so it knows which side is most recently updated, or if BOTH have
been updated</em> - protect these state files or you have to resolve
everything again.</p>
<p>If you need more than two ends, make a star topology.</p>
<section id="unison-syncing-data">
<h3>Unison: syncing data<a class="headerlink" href="#unison-syncing-data" title="Permalink to this heading"></a></h3>
<p>Unison is a program that does bi-directional syncing.  It uses the
rsync protocol to do the actual transfers.</p>
<p>Unison has to be installed on both sides.  Since recently, the version
numbers don’t have to exactly match.  You can download and use a
static binary.  It has a GPU that is good for seeing and resolving
changes, and a command line interface.</p>
<section id="using-unison">
<h4>Using unison<a class="headerlink" href="#using-unison" title="Permalink to this heading"></a></h4>
<p>The basic syntax looks like:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">unison word-count/ ssh://HOSTNAME//full/path/to/word-count/</span>
</pre></div>
</div>
<p>It stores the state files in <code class="docutils literal notranslate"><span class="pre">~/.unison/</span></code></p>
<div class="admonition-demonstration-of-unison demo admonition" id="demo-2">
<p class="admonition-title">Demonstration of unison</p>
<p>Syncing a directory from one place to another.  Show Unison from
command line without profiles</p>
</div>
<div class="admonition-unison exercise important admonition" id="exercise-0">
<p class="admonition-title">unison</p>
<ul class="simple">
<li><p>Install unison</p></li>
<li><p>Sync one directory</p></li>
<li><p>Modify two different files (one on each end) and re-sync</p></li>
<li><p>Modify the same file on both ends. Re-sync and see how it doesn’t
touch that file until you specify how to resolve the conflict.</p></li>
</ul>
</div>
</section>
</section>
</section>
<section id="git-annex">
<h2>git-annex<a class="headerlink" href="#git-annex" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://git-annex.branchable.com/">git-annex</a> lets git track large
files, but it <em>doesn’t</em> store the contents of the files in the git
history: instead, there are other commands that move the files
directly from remote to remote. (<code class="docutils literal notranslate"><span class="pre">dvc</span></code> is similar)</p>
<p>git-annex is nice for some cases, but it can be rather hard to use.
Aalto SciComp has a <a class="reference external" href="https://scicomp.aalto.fi/scicomp/git-annex/">git-annex guide for
scientists</a>, which
explains things slightly more usably.</p>
<p>Personal opinion (RD): Ask for help if you want to set it up.  It
should probably be used more than it is, but for now let’s consider it
a specialist’s tool.</p>
<div class="admonition-git-annex exercise important admonition" id="exercise-1">
<p class="admonition-title">git-annex</p>
<ul class="simple">
<li><p>Install git-annex</p></li>
<li><p>Init a git-annex repository</p></li>
<li><p>Record one file with git-annex</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">git-annex</span> <span class="pre">list</span></code></p></li>
</ul>
</div>
</section>
<section id="mounting-data-from-place-to-place">
<h2>Mounting data from place to place<a class="headerlink" href="#mounting-data-from-place-to-place" title="Permalink to this heading"></a></h2>
<p>You can mount data and use it from one place to another: it becomes
two views of the same data.</p>
<ul class="simple">
<li><p>Data isn’t copied, but a view is made (technical term: filesystem mount)</p></li>
<li><p>Commonly used within internal networks (this is how all files on all nodes on a cluster look the same)</p></li>
<li><p>Useful for (for example) viewing output figures and so on.</p></li>
<li><p>Common and easy to use: sshfs</p></li>
<li><p>These are as slow as the internet connection between the files.
Userspace tools like sshfs are even slower.</p></li>
</ul>
<div class="admonition-demo demo admonition" id="demo-3">
<p class="admonition-title">Demo</p>
<p>Show SSHFS from desktop to cluster</p>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this heading"></a></h2>
<p>There are four ways of transferring data:</p>
<ul class="simple">
<li><p>Copy data one-way</p></li>
<li><p>Synchronize data two-ways</p></li>
<li><p>Use git-annex to track data</p></li>
<li><p>Do a filesystem mount (sshfs)</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../Project_arrangement/" class="btn btn-neutral float-left" title="Project arrangement" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../Code_sync/" class="btn btn-neutral float-right" title="Code sync" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-, The contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>